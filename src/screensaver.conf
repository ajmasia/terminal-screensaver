#!/bin/bash
# Screensaver configuration loader
# Sources user config and provides defaults

CONFIG_FILE="$HOME/.config/terminal-screensaver/screensaver.conf"
SCREENSAVER_DIR="$HOME/.local/share/terminal-screensaver"
LOG_DIR="${XDG_STATE_HOME:-$HOME/.local/state}/terminal-screensaver"
LOG_FILE="$LOG_DIR/screensaver.log"

# Ensure log directory exists
mkdir -p "$LOG_DIR"

# Logging function
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $*" >> "$LOG_FILE"
}

# Default values
TERMINAL_SCREENSAVER_TERMINAL="${TERMINAL_SCREENSAVER_TERMINAL:-alacritty}"
TERMINAL_SCREENSAVER_ASCII_FILE="${TERMINAL_SCREENSAVER_ASCII_FILE:-$HOME/.config/terminal-screensaver/screensaver.txt}"
TERMINAL_SCREENSAVER_IDLE_TIMEOUT="${TERMINAL_SCREENSAVER_IDLE_TIMEOUT:-120}"
TERMINAL_SCREENSAVER_FRAME_RATE="${TERMINAL_SCREENSAVER_FRAME_RATE:-60}"
TERMINAL_SCREENSAVER_EXCLUDE_EFFECTS="${TERMINAL_SCREENSAVER_EXCLUDE_EFFECTS:-dev_worm}"
TERMINAL_SCREENSAVER_FONT_SIZE="${TERMINAL_SCREENSAVER_FONT_SIZE:-16}"

# Load user config if exists
if [[ -f "$CONFIG_FILE" ]]; then
    # shellcheck source=/dev/null
    source "$CONFIG_FILE"
fi

# Validate terminal choice and check availability
case "$TERMINAL_SCREENSAVER_TERMINAL" in
    alacritty|gnome-terminal|ptyxis)
        if ! command -v "$TERMINAL_SCREENSAVER_TERMINAL" &>/dev/null; then
            echo "Warning: Terminal '$TERMINAL_SCREENSAVER_TERMINAL' not found. Using gnome-terminal." >&2
            TERMINAL_SCREENSAVER_TERMINAL="gnome-terminal"
        fi
        ;;
    *)
        echo "Warning: Invalid terminal '$TERMINAL_SCREENSAVER_TERMINAL'. Using gnome-terminal." >&2
        TERMINAL_SCREENSAVER_TERMINAL="gnome-terminal"
        ;;
esac

# Export all config variables
export TERMINAL_SCREENSAVER_TERMINAL
export TERMINAL_SCREENSAVER_ASCII_FILE
export TERMINAL_SCREENSAVER_IDLE_TIMEOUT
export TERMINAL_SCREENSAVER_FRAME_RATE
export TERMINAL_SCREENSAVER_EXCLUDE_EFFECTS
export TERMINAL_SCREENSAVER_FONT_SIZE
